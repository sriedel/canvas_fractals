<!DOCTYPE html>

<html>
  <head></head>
  <body>
    <canvas id="canvas" width="400" height="400"></canvas>

    <script>
      var Complex = function( real, imaginary ) {
                      this.real = real;
                      this.imaginary = imaginary;
                    };
      Complex.prototype.complement = 
        function() {
          return new Complex( this.real, -this.imaginary );
        };

      Complex.prototype.add = 
        function( value ) {
          return new Complex( this.real + value.real, 
                              this.imaginary + value.imaginary );
        };

      Complex.prototype.multiply = 
        function( value ) {
          var new_real = this.real * value.real - 
                         this.imaginary * value.imaginary;
          var new_imaginary = this.real * value.imaginary + 
                              this.imaginary * value.real;
          return new Complex( new_real, new_imaginary );
        };

      Complex.prototype.absolute = 
        function() {
          return Math.sqrt( this.multiply( this.complement() ).real );
        };


      var JuliaPainter = function( width, height ) {
        this.minReal = -2.0;
        this.maxReal = 2.0;
        this.minImg = -2.0;
        this.maxImg = 2.0;

        this.width = width;
        this.height = height;
        this.realStep = ( this.maxReal - this.minReal ) / width;
        this.imgStep = ( this.maxImg - this.minImg ) / height;
      };

      JuliaPainter.prototype.compute = 
        function( iterations, func, resultArray ) {
          var point = new Complex( this.minReal, this.maxImg );

          for( var y = 0;
                   y < this.height;
                   ++y, point.imaginary -= this.imgStep ) {

            point.real = this.minReal;
            for( var x = 0;
                     x < this.width;
                     ++x, point.real += this.realStep ) {

              var resultIndex = y * this.width + x;
              resultArray[resultIndex] = this.spotCompute( iterations, point, func );
            }
          }
        };

      JuliaPainter.prototype.spotCompute =
        function( iterations, point, func ) {
          var computePoint = new Complex( point.real, point.imaginary );

          for( var i = 0; i < iterations; ++i ) {
            computePoint = func( computePoint );
            if( computePoint.absolute() >= 2.0 ) {
              return false;
            }
          }
          return true;
        };

      JuliaPainter.prototype.buildImage = 
        function( origin, imageDataResult ) {
          for( var y = 0 ; y < this.height; ++y ) {
            for( var x = 0; x < this.width; ++x ) {
              var originIndex = y * this.width + x;
              var imageDataIndex = originIndex * 4; // RGBA

              var color = origin[originIndex] ? 255 : 0;
              imageDataResult.data[imageDataIndex] = color;
              imageDataResult.data[imageDataIndex + 1] = color;
              imageDataResult.data[imageDataIndex + 2] = color;
              imageDataResult.data[imageDataIndex + 3] = 255; // Alpha
            }
          }
        }


      var canvas = document.getElementById( 'canvas' );
      var context = canvas.getContext( "2d" );
      var imagedata = context.createImageData( 400, 400 );
      for( var i = 0, len = imagedata.data.length; i < len ; ++i ) {
        imagedata.data[i] = 128;
      }
      context.putImageData( imagedata, 0, 0 );

      var julia = new JuliaPainter( 400, 400 );
      var resultArray = [];
      julia.compute( 50, 
                     function( c ) {
                       return c.multiply( c ).add( new Complex( -0.3, 0 ) );
                     },
                     resultArray );
      julia.buildImage( resultArray, imagedata );
      context.putImageData( imagedata, 0, 0 );
    </script>
  </body>
</html>
